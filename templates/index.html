<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fish Audio ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¼šè©±ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .recording-tips {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }
        
        .recording-tips p {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-weight: 600;
        }
        
        .recording-tips ul {
            margin: 0;
            padding-left: 20px;
            color: #1565c0;
        }
        
        .recording-tips li {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #2e7d32;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .recording-indicator {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .recording-indicator.recording {
            display: block;
        }

        .pulse {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc3545;
            display: inline-block;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }



        .text-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .text-input input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .text-input input:focus {
            border-color: #667eea;
        }

        .text-input button {
            padding: 15px 25px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .text-input button:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .auto-recording-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #0c5460;
        }
        
        .auto-recording-info h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        
        .auto-recording-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .auto-recording-info li {
            margin: 5px 0;
        }
        
        .auto-recording-info em {
            color: #6c757d;
            font-style: italic;
        }
        
        /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .realtime-audio-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .realtime-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .realtime-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .audio-level-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .level-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .level-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e, #16a34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 4px;
            border-radius: 4px;
        }
        
        .level-value {
            font-size: 14px;
            font-weight: 600;
            min-width: 30px;
            text-align: right;
        }
        
        .realtime-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .current-text {
            min-height: 60px;
            display: flex;
            align-items: center;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .current-text .placeholder {
            opacity: 0.7;
            font-style: italic;
        }
        
        .current-text .live-text {
            color: #fbbf24;
            font-weight: 500;
        }
        
        .confidence {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .confidence-value {
            font-weight: 600;
            color: #fbbf24;
        }
        
        /* éŒ²éŸ³ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .realtime-audio-display.recording .current-text .live-text {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin: 10px 0; /* ä¸Šä¸‹ã®é–“éš”ã‚’ã•ã‚‰ã«ç¸®å° */
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-outline-secondary {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
        }
        
        .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.8);
        }
        
        .conversation {
            background: #f8f9fa;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            min-height: 200px;
            margin-bottom: 10px; /* å…¥åŠ›ã‚³ãƒ³ãƒ†ãƒŠã¨ã®é–“éš”ã‚’ç¸®å° */
        }
        
        .message {
            display: flex;
            margin-bottom: 20px;
            max-width: 85%;
        }
        
        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            margin-right: auto;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 10px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .sales-script-controls {
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
        }
        
        .sales-script-controls h5 {
            margin-bottom: 15px;
            color: #856404;
            text-align: center;
        }
        
        .script-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .script-btn {
            padding: 10px 15px;
            border: 1px solid #ffc107;
            background: #fff3cd;
            color: #856404;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .script-btn:hover {
            background: #ffc107;
            color: #fff;
            transform: translateY(-2px);
        }
        
        .full-script-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .full-script-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .script-content {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .script-content .script-label {
            font-weight: bold;
            color: #155724;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .script-content .script-text {
            color: #155724;
            line-height: 1.5;
        }
        
        .conversation-status {
            margin: 15px 0;
            padding: 15px;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
        }
        
        .conversation-status h5 {
            margin-bottom: 15px;
            color: #1976d2;
            text-align: center;
        }
        
        .status-info {
            display: grid;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .status-item .label {
            font-weight: 600;
            color: #333;
        }
        
        .status-item .value {
            color: #1976d2;
            font-weight: 500;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #333;
        }
        
        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-messages {
            background: #f8f9fa;
            padding: 20px;
            max-height: none; /* é«˜ã•åˆ¶é™ã‚’å‰Šé™¤ã—ã¦å…¥åŠ›ã‚³ãƒ³ãƒ†ãƒŠã‚’å«ã‚ã‚‹ */
            overflow-y: visible; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ– */
            min-height: 200px;
            margin-bottom: 0px;
            border-radius: 10px;
        }
        
        /* å…¥åŠ›ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input-container {
            margin-top: 0px;
            padding-top: 15px; /* ä¸Šéƒ¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—åŠ  */
            border-top: 1px solid #e9ecef; /* ä¸Šéƒ¨ã«å¢ƒç•Œç·šã‚’è¿½åŠ  */
        }
        

        
        .message-text {
            margin-bottom: 8px;
            word-wrap: break-word;
            line-height: 1.5;
            font-size: 15px;
        }
        
        .message-time {
            font-size: 12px;
            opacity: 0.7;
            text-align: right;
        }
        
        .message.user .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message.assistant .message-time {
            color: #666;
        }
        
        .user-text {
            font-size: 13px;
            color: #666;
            font-style: italic;
            margin: 8px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .conversation::-webkit-scrollbar {
            width: 8px;
        }
        
        .conversation::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .conversation::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .conversation::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #721c24;
            text-align: center;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .voice-selection {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
        }

        .voice-selection label {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .voice-select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .voice-select:focus {
            border-color: #667eea;
        }
        
        .mode-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            background: #e3f2fd;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #2196f3;
        }
        
        .mode-selector label {
            font-weight: 600;
            color: #1976d2;
            margin: 0;
        }
        
        .mode-selector select {
            padding: 10px 15px;
            border: 2px solid #2196f3;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.3s ease;
        }
        
        .mode-selector select:focus {
            border-color: #0d47a1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŸ Fish Audio</h1>
            <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°ä¼šè©±ã‚¢ãƒ—ãƒª</p>
                    <div class="recording-tips">
            <p><strong>éŸ³å£°éŒ²éŸ³ã®ã‚³ãƒ„:</strong></p>
            <ul>
                <li>é™ã‹ãªç’°å¢ƒã§éŒ²éŸ³ã—ã¦ãã ã•ã„</li>
                <li>ãƒã‚¤ã‚¯ã«è¿‘ã¥ã„ã¦ã€ã¯ã£ãã‚Šã¨è©±ã—ã¦ãã ã•ã„</li>
                <li>éŒ²éŸ³æ™‚é–“ã¯3-10ç§’ç¨‹åº¦ãŒæœ€é©ã§ã™</li>
                <li>æ—¥æœ¬èªã§è©±ã—ã¦ãã ã•ã„</li>
            </ul>
        </div>
        
        <!-- ä¼šè©±ç®¡ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹è¡¨ç¤º -->
        <div class="conversation-status" id="conversationStatus">
            <h5>ä¼šè©±ç®¡ç†ã‚¨ãƒ³ã‚¸ãƒ³</h5>
            <div class="status-info">
                <div class="status-item">
                    <span class="label">çŠ¶æ…‹:</span>
                    <span class="value" id="conversationState">-</span>
                </div>
                <div class="status-item">
                    <span class="label">ã‚¹ãƒ­ãƒƒãƒˆå……è¶³ç‡:</span>
                    <span class="value" id="slotCompletionRate">-</span>
                </div>
                <div class="status-item">
                    <span class="label">æ¬¡ã®è³ªå•:</span>
                    <span class="value" id="nextQuestion">-</span>
                </div>
            </div>
        </div>

        <div class="status" id="status">
            æ¥ç¶šä¸­...
        </div>

                <div class="controls">
            <button class="btn btn-primary" id="startRecording">
                ä¼šè©±ã™ã‚‹
            </button>
            <button class="btn btn-danger" id="stopRecording" disabled>
                ä¼šè©±åœæ­¢
            </button>

        </div>
        
        <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="chat-container">
            <div class="chat-header">
                <h4>ä¼šè©±å±¥æ­´</h4>
                <button class="btn btn-sm btn-outline-secondary" id="clearConversation">
                    ã‚¯ãƒªã‚¢
                </button>
            </div>
            <div class="conversation" id="conversation">
                <div class="message assistant">
                    <div class="message-avatar">A</div>
                    <div class="message-content">
                        <div class="message-text">ã“ã‚“ã«ã¡ã¯ï¼éŸ³å£°ã§ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</div>
                        <div class="message-time">ä»Š</div>
                    </div>
                </div>
            </div>
            
            <!-- å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="sales-script-controls">
                <h5>å–¶æ¥­ãƒˆãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ</h5>
                <div class="script-buttons">
                    <button class="script-btn" data-step="greeting">æŒ¨æ‹¶</button>
                    <button class="script-btn" data-step="introduction">è‡ªå·±ç´¹ä»‹</button>
                    <button class="script-btn" data-step="apology">è¬ç½ª</button>
                    <button class="script-btn" data-step="business_intro">äº‹æ¥­ç´¹ä»‹</button>
                    <button class="script-btn" data-step="product_intro">å•†å“ç´¹ä»‹</button>
                    <button class="script-btn" data-step="features">ç‰¹å¾´èª¬æ˜</button>
                    <button class="script-btn" data-step="sample_offer">ã‚µãƒ³ãƒ—ãƒ«æä¾›</button>
                    <button class="script-btn" data-step="request_info">æƒ…å ±ä¾é ¼</button>
                </div>
                <button class="full-script-btn" id="fullScriptBtn">å®Œå…¨ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ç”Ÿ</button>
            </div>
        </div>
        
        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="realtime-audio-display" id="realtimeAudioDisplay" style="display: none;">
            <div class="realtime-header">
                <h4>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜</h4>
                <div class="audio-level-indicator">
                    <span class="level-label">éŸ³å£°ãƒ¬ãƒ™ãƒ«:</span>
                    <div class="level-bar">
                        <div class="level-fill" id="audioLevelFill"></div>
                    </div>
                    <span class="level-value" id="audioLevelValue">0</span>
                </div>
            </div>
            <div class="realtime-content">
                <div class="current-text" id="currentText">
                    <span class="placeholder">éŸ³å£°ã‚’è©±ã—ã¦ãã ã•ã„...</span>
                </div>
                <div class="confidence" id="confidence">
                    <span class="confidence-label">èªè­˜ç²¾åº¦:</span>
                    <span class="confidence-value" id="confidenceValue">--</span>
                </div>
            </div>
        </div>
        


        <div class="voice-selection">
            <label for="voiceSelect">éŸ³å£°ãƒ¢ãƒ‡ãƒ«:</label>
            <select id="voiceSelect" class="voice-select">
                <option value="japanese-female-1">æ—¥æœ¬èªï¼ˆå¥³æ€§1ï¼‰</option>
                <option value="japanese-male-1">æ—¥æœ¬èªï¼ˆç”·æ€§1ï¼‰</option>
                <option value="japanese-female-2">æ—¥æœ¬èªï¼ˆå¥³æ€§2ï¼‰</option>
                <option value="english-female-1">è‹±èªï¼ˆå¥³æ€§1ï¼‰</option>
                <option value="english-male-1">è‹±èªï¼ˆç”·æ€§1ï¼‰</option>
                <option value="chinese-female-1">ä¸­å›½èªï¼ˆå¥³æ€§1ï¼‰</option>
                <option value="korean-female-1">éŸ“å›½èªï¼ˆå¥³æ€§1ï¼‰</option>
                <option value="fbea303b64374bffb8843569404b095e">ã¾ãªï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¤ã‚¹ï¼‰</option>
                <option value="test-female">ãƒ†ã‚¹ãƒˆç”¨å¥³æ€§éŸ³å£°</option>
                <option value="test-male">ãƒ†ã‚¹ãƒˆç”¨ç”·æ€§éŸ³å£°</option>
                <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°</option>
                <option value="auto">è‡ªå‹•é¸æŠ</option>
            </select>
        </div>

        <div class="recording-indicator" id="recordingIndicator">
            <span class="pulse"></span>
            éŒ²éŸ³ä¸­...
        </div>

        <div class="chat-container">

            

            
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-content">
                        <p>AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨ä¼šè©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã¾ãŸã¯éŸ³å£°éŒ²éŸ³ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã™ã€‚</p>
                    </div>
                </div>
                
                <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ä¼šè©±å±¥æ­´ã®ç›´ä¸‹ã«ç§»å‹• -->
                <div class="input-container">
                    <div class="text-input-container">
                        <input type="text" id="textInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." />
                        <button id="sendTextBtn">é€ä¿¡</button>
                    </div>
                    
                    <div class="voice-input-container">
                        <button id="recordBtn" class="record-btn">éŒ²éŸ³é–‹å§‹</button>
                        <button id="stopRecordBtn" class="stop-record-btn" style="display: none;">éŒ²éŸ³åœæ­¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IOæ¥ç¶š
        const socket = io();
        
        // DOMè¦ç´ 
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startRecording');
        const stopBtn = document.getElementById('stopRecording');
        const clearBtn = document.getElementById('clearConversation');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const conversationEl = document.getElementById('conversation');
        const textInput = document.getElementById('textInput');
        const sendTextBtn = document.getElementById('sendText');

        // éŸ³å£°éŒ²éŸ³é–¢é€£
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Socket.IOã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        socket.on('connect', () => {
            statusEl.textContent = 'æ¥ç¶šã•ã‚Œã¾ã—ãŸ';
            statusEl.style.background = '#e8f5e8';
            statusEl.style.borderColor = '#4caf50';
            statusEl.style.color = '#2e7d32';
        });

        socket.on('disconnect', () => {
            statusEl.textContent = 'æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ';
            statusEl.style.background = '#fff3cd';
            statusEl.style.borderColor = '#ffc107';
            statusEl.style.color = '#856404';
        });

        socket.on('status', (data) => {
            statusEl.textContent = data.message;
        });

        socket.on('error', (data) => {
            console.error('âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', data);
            if (data.message) {
                showError(data.message);
            } else if (data.error) {
                showError(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
            } else {
                showError('ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        });

        // éŸ³å£°ãƒ¢ãƒ‡ãƒ«é¸æŠã®å¤‰æ›´ã‚’ç›£è¦–
        document.getElementById('voiceSelect').addEventListener('change', (e) => {
            const selectedVoice = e.target.value;
            console.log('ğŸµ éŸ³å£°ãƒ¢ãƒ‡ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', selectedVoice);
            
            // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            let modelName = '';
            let modelDescription = '';
            
            switch(selectedVoice) {
                case 'fbea303b64374bffb8843569404b095e':
                    modelName = 'ã¾ãªï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¤ã‚¹ï¼‰';
                    modelDescription = 'å…ƒæ°—ã§æ˜ã‚‹ã„å¥³æ€§ã®å£° - Fish Audioã®ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¤ã‚¹';
                    break;
                case 'japanese-female-1':
                    modelName = 'æ—¥æœ¬èªï¼ˆå¥³æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªæ—¥æœ¬èªå¥³æ€§ã®å£°';
                    break;
                case 'japanese-male-1':
                    modelName = 'æ—¥æœ¬èªï¼ˆç”·æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªæ—¥æœ¬èªç”·æ€§ã®å£°';
                    break;
                case 'japanese-female-2':
                    modelName = 'æ—¥æœ¬èªï¼ˆå¥³æ€§2ï¼‰';
                    modelDescription = 'åˆ¥ã®æ—¥æœ¬èªå¥³æ€§ã®å£°';
                    break;
                case 'english-female-1':
                    modelName = 'è‹±èªï¼ˆå¥³æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªè‹±èªå¥³æ€§ã®å£°';
                    break;
                case 'english-male-1':
                    modelName = 'è‹±èªï¼ˆç”·æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªè‹±èªç”·æ€§ã®å£°';
                    break;
                case 'chinese-female-1':
                    modelName = 'ä¸­å›½èªï¼ˆå¥³æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªä¸­å›½èªå¥³æ€§ã®å£°';
                    break;
                case 'korean-female-1':
                    modelName = 'éŸ“å›½èªï¼ˆå¥³æ€§1ï¼‰';
                    modelDescription = 'æ¨™æº–çš„ãªéŸ“å›½èªå¥³æ€§ã®å£°';
                    break;
                case 'test-female':
                    modelName = 'ãƒ†ã‚¹ãƒˆç”¨å¥³æ€§éŸ³å£°';
                    modelDescription = 'ãƒ†ã‚¹ãƒˆç”¨ã®å¥³æ€§éŸ³å£°ãƒ¢ãƒ‡ãƒ«';
                    break;
                case 'test-male':
                    modelName = 'ãƒ†ã‚¹ãƒˆç”¨ç”·æ€§éŸ³å£°';
                    modelDescription = 'ãƒ†ã‚¹ãƒˆç”¨ã®ç”·æ€§éŸ³å£°ãƒ¢ãƒ‡ãƒ«';
                    break;
                case 'default':
                    modelName = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³å£°';
                    modelDescription = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®éŸ³å£°ãƒ¢ãƒ‡ãƒ«';
                    break;
                case 'auto':
                    modelName = 'è‡ªå‹•é¸æŠ';
                    modelDescription = 'ã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«é¸æŠã•ã‚Œã‚‹éŸ³å£°ãƒ¢ãƒ‡ãƒ«';
                    break;
                default:
                    modelName = 'ä¸æ˜ãªãƒ¢ãƒ‡ãƒ«';
                    modelDescription = 'ä¸æ˜ãªéŸ³å£°ãƒ¢ãƒ‡ãƒ«';
            }
            
            console.log('ğŸ“ é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«å:', modelName);
            console.log('ğŸ“‹ ãƒ¢ãƒ‡ãƒ«èª¬æ˜:', modelDescription);
            console.log('ğŸ”‘ ãƒ¢ãƒ‡ãƒ«ID:', selectedVoice);
            
            // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ãŒã¾ãªã®å ´åˆã€ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (selectedVoice === 'fbea303b64374bffb8843569404b095e') {
                console.log('ğŸŒŸ ã¾ãªã®ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼');
                console.log('ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹éŸ³å£°: å…ƒæ°—ã§æ˜ã‚‹ã„å¥³æ€§ã®å£°');
                console.log('âš ï¸  æ³¨æ„: ã“ã®ãƒ¢ãƒ‡ãƒ«IDãŒæ­£ã—ãå‹•ä½œã—ãªã„å ´åˆã¯ã€Fish Audio APIã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            }
        });

        // è‡ªå‹•éŒ²éŸ³ã®è¨­å®š
        let autoRecording = false;
        let audioContext;
        let analyser;
        let microphone;
        let silenceTimer;
        let isAutoRecording = false;
        
        // è‡ªå‹•ä¼šè©±ã®é–‹å§‹
        function startAutoRecording() {
            if (autoRecording || isAutoRecording) return;
            
            console.log('ğŸ¤ è‡ªå‹•ä¼šè©±é–‹å§‹å‡¦ç†ä¸­...');
            
            try {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    console.log('âœ… ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    microphone = audioContext.createMediaStreamSource(stream);
                    
                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.8;
                    microphone.connect(analyser);
                    
                    isAutoRecording = true;
                    autoRecording = true;
                    startBtn.textContent = 'ğŸ”„ ä¼šè©±ä¸­...';
                    startBtn.disabled = true;
                    stopBtn.textContent = 'â¹ï¸ ä¼šè©±åœæ­¢';
                    stopBtn.disabled = false;
                    recordingIndicator.classList.add('recording');
                    
                    console.log('ğŸ¤ è‡ªå‹•ä¼šè©±é–‹å§‹å®Œäº†');
                    console.log('ğŸ” éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–é–‹å§‹');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æœ‰åŠ¹åŒ–
                    toggleRealtimeDisplay(true);
                    updateCurrentText('éŸ³å£°ã‚’è©±ã—ã¦ãã ã•ã„...', false);
                    
                    // Fish Audio APIé€£æºãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜ã‚’åˆæœŸåŒ–
                    initFishAudioRealtimeSTT();
                    
                    monitorAudioLevel();
                }).catch(error => {
                    console.error('âŒ ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    showError('ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¼šè©±é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                showError('è‡ªå‹•ä¼šè©±ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ç›£è¦–
        function monitorAudioLevel() {
            if (!isAutoRecording) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®å¹³å‡ã‚’è¨ˆç®—
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += dataArray[i];
            }
            const average = sum / bufferLength;
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°
            updateRealtimeDisplay(average);
            
            // ãƒ‡ãƒãƒƒã‚°: éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
            if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§ãƒ­ã‚°å‡ºåŠ›
                console.log(`ğŸµ éŸ³å£°ãƒ¬ãƒ™ãƒ«: ${average.toFixed(1)} (éŒ²éŸ³ä¸­: ${isRecording})`);
            }
            
            // éŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒä¸€å®šä»¥ä¸Šãªã‚‰éŒ²éŸ³é–‹å§‹
            if (average > 15 && !isRecording) {
                console.log(`ğŸ¤ éŸ³å£°æ¤œå‡ºï¼éŒ²éŸ³é–‹å§‹ (ãƒ¬ãƒ™ãƒ«: ${average.toFixed(1)})`);
                startRecordingFromStream();
            }
            // ç„¡éŸ³ãŒç¶šã„ãŸã‚‰éŒ²éŸ³åœæ­¢
            else if (average < 8 && isRecording) {
                if (silenceTimer) clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    if (isRecording) {
                        console.log(`ğŸ¤ ç„¡éŸ³æ¤œå‡ºï¼éŒ²éŸ³åœæ­¢ (ãƒ¬ãƒ™ãƒ«: ${average.toFixed(1)})`);
                        stopRecordingFromStream();
                    }
                }, 2000); // 2ç§’ã®ç„¡éŸ³ã§éŒ²éŸ³åœæ­¢
            }
            
            requestAnimationFrame(monitorAudioLevel);
        }
        
        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰éŒ²éŸ³é–‹å§‹
        function startRecordingFromStream() {
            if (isRecording) return;
            
            try {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(audioStream => {
                    console.log('ğŸ¤ éŒ²éŸ³ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');
                    
                    mediaRecorder = new MediaRecorder(audioStream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                            console.log(`ğŸ“¦ éŸ³å£°ãƒ‡ãƒ¼ã‚¿å—ä¿¡: ${event.data.size} bytes`);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        console.log('â¹ï¸ MediaRecorderåœæ­¢');
                        
                        if (audioChunks.length > 0) {
                            // ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚µãƒãƒ¼ãƒˆã™ã‚‹éŸ³å£°å½¢å¼ã‚’ä½¿ç”¨
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = () => {
                                const base64Audio = reader.result.split(',')[1];
                                const selectedVoice = document.getElementById('voiceSelect').value;
                                console.log('ğŸµ è‡ªå‹•éŒ²éŸ³æ™‚ã®éŸ³å£°ãƒ¢ãƒ‡ãƒ«:', selectedVoice);
                                console.log('ğŸ¤ éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', base64Audio.length, 'æ–‡å­—');
                                console.log('ğŸµ éŸ³å£°å½¢å¼:', audioBlob.type);
                                
                                console.log('ğŸ“¡ éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...');
                                socket.emit('audio_data', { 
                                    audio: base64Audio,
                                    voice_id: selectedVoice,
                                    format: audioBlob.type
                                });
                                console.log('âœ… éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†');
                                
                                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã«æ›´æ–°
                                updateCurrentText('ğŸ”„ éŸ³å£°èªè­˜ä¸­...', false);
                                
                                // éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†å¾Œã€æ¬¡ã®éŒ²éŸ³ã‚’æº–å‚™
                                setTimeout(() => {
                                    if (autoRecording && !isRecording) {
                                        console.log('ğŸ”„ æ¬¡ã®éŒ²éŸ³ã®æº–å‚™å®Œäº†ã€éŸ³å£°ã‚’å¾…æ©Ÿä¸­...');
                                        updateCurrentText('ğŸ¤ éŸ³å£°ã‚’è©±ã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•éŒ²éŸ³å¾…æ©Ÿä¸­ï¼‰', false);
                                    }
                                }, 1000);
                            };
                            reader.readAsDataURL(audioBlob);
                        } else {
                            console.log('âš ï¸ éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒå—ä¿¡ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                        }
                    };

                    mediaRecorder.start(100); // 100msã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    isRecording = true;
                    console.log('ğŸ¤ éŒ²éŸ³é–‹å§‹ï¼ˆè‡ªå‹•ï¼‰');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’éŒ²éŸ³ä¸­ãƒ¢ãƒ¼ãƒ‰ã«æ›´æ–°
                    updateCurrentText('ğŸ¤ éŒ²éŸ³ä¸­... è©±ã—ã¦ãã ã•ã„', true);
                });
            } catch (error) {
                console.error('è‡ªå‹•éŒ²éŸ³ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // Fish Audio APIã¨é€£æºã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜
        let isRealtimeSTT = false;
        let sttInterval = null;
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°
        function updateRealtimeDisplay(audioLevel) {
            const display = document.getElementById('realtimeAudioDisplay');
            const levelFill = document.getElementById('audioLevelFill');
            const levelValue = document.getElementById('audioLevelValue');
            
            if (display && levelFill && levelValue) {
                // éŸ³å£°ãƒ¬ãƒ™ãƒ«ãƒãƒ¼ã‚’æ›´æ–°
                const percentage = Math.min((audioLevel / 50) * 100, 100);
                levelFill.style.width = percentage + '%';
                levelValue.textContent = Math.round(audioLevel);
                
                // éŒ²éŸ³ä¸­ã‹ã©ã†ã‹ã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
                if (isRecording) {
                    display.classList.add('recording');
                } else {
                    display.classList.remove('recording');
                }
            }
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’è¡¨ç¤º/éè¡¨ç¤º
        function toggleRealtimeDisplay(show) {
            const display = document.getElementById('realtimeAudioDisplay');
            if (display) {
                display.style.display = show ? 'block' : 'none';
                console.log(`ğŸ–¥ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º: ${show ? 'è¡¨ç¤º' : 'éè¡¨ç¤º'}`);
            } else {
                console.error('âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        function updateCurrentText(text, isLive = false) {
            const currentText = document.getElementById('currentText');
            if (currentText) {
                if (isLive) {
                    currentText.innerHTML = `<span class="live-text">${text}</span>`;
                } else {
                    currentText.innerHTML = text;
                }
                console.log(`ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°: ${text} (ãƒ©ã‚¤ãƒ–: ${isLive})`);
            } else {
                console.error('âŒ ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // Fish Audio APIã¨é€£æºã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
        function initFishAudioRealtimeSTT() {
            if (isRealtimeSTT) return;
            
            console.log('ğŸ¤ Fish Audio APIé€£æºãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜é–‹å§‹');
            isRealtimeSTT = true;
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°
            updateCurrentText('ğŸ¤ Fish Audio APIé€£æºä¸­... è©±ã—ã¦ãã ã•ã„', true);
            
            // éŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒä¸€å®šä»¥ä¸Šã«ãªã£ãŸã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTã‚’é–‹å§‹
            startRealtimeSTT();
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTã®é–‹å§‹
        function startRealtimeSTT() {
            if (!isRealtimeSTT || isRecording) return;
            
            console.log('ğŸ¤ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTé–‹å§‹');
            
            // çŸ­ã„é–“éš”ã§éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦STTå‡¦ç†
            sttInterval = setInterval(() => {
                if (isRealtimeSTT && !isRecording && autoRecording) {
                    // ç¾åœ¨ã®éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’ç¢ºèª
                    if (analyser && audioContext) {
                        const bufferLength = analyser.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);
                        analyser.getByteFrequencyData(dataArray);
                        
                        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®å¹³å‡ã‚’è¨ˆç®—
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }
                        const average = sum / bufferLength;
                        
                        // éŸ³å£°ãƒ¬ãƒ™ãƒ«ãŒä¸€å®šä»¥ä¸Šãªã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTå‡¦ç†
                        if (average > 20) {
                            console.log(`ğŸ¤ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTå‡¦ç†ä¸­ (ãƒ¬ãƒ™ãƒ«: ${average.toFixed(1)})`);
                            updateCurrentText(`ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜ä¸­... (ãƒ¬ãƒ™ãƒ«: ${average.toFixed(1)})`, true);
                            
                            // çŸ­æ™‚é–“ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦STTå‡¦ç†
                            captureShortAudioForSTT();
                        }
                    }
                }
            }, 500); // 500msã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        }
        
        // çŸ­æ™‚é–“ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦STTå‡¦ç†
        function captureShortAudioForSTT() {
            if (!audioContext || !microphone) return;
            
            try {
                // çŸ­æ™‚é–“ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’éŒ²éŸ³
                const mediaRecorder = new MediaRecorder(microphone.stream);
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64Audio = reader.result.split(',')[1];
                            
                            // Fish Audio APIã«çŸ­æ™‚é–“éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                            console.log('ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTç”¨éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­...');
                            socket.emit('realtime_stt', { 
                                audio: base64Audio,
                                voice_id: document.getElementById('voiceSelect').value
                            });
                        };
                        reader.readAsDataURL(audioBlob);
                    }
                };
                
                // 1ç§’é–“éŒ²éŸ³
                mediaRecorder.start();
                setTimeout(() => {
                    mediaRecorder.stop();
                }, 1000);
                
            } catch (error) {
                console.error('âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTéŒ²éŸ³ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTã®åœæ­¢
        function stopRealtimeSTT() {
            if (sttInterval) {
                clearInterval(sttInterval);
                sttInterval = null;
            }
            isRealtimeSTT = false;
            console.log('ğŸ›‘ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTåœæ­¢');
        }
        
        // èªè­˜ç²¾åº¦ã‚’æ›´æ–°
        function updateConfidence(confidence) {
            const confidenceValue = document.getElementById('confidenceValue');
            if (confidenceValue) {
                confidenceValue.textContent = confidence + '%';
                console.log(`ğŸ“Š èªè­˜ç²¾åº¦æ›´æ–°: ${confidence}%`);
            } else {
                console.error('âŒ èªè­˜ç²¾åº¦è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‹ã‚‰éŒ²éŸ³åœæ­¢
        function stopRecordingFromStream() {
            if (!isRecording) return;
            
            console.log('â¹ï¸ éŒ²éŸ³åœæ­¢å‡¦ç†é–‹å§‹');
            
            if (mediaRecorder && isRecording) {
                try {
                    // éŒ²éŸ³ã‚’åœæ­¢
                    mediaRecorder.stop();
                    isRecording = false;
                    console.log('â¹ï¸ éŒ²éŸ³åœæ­¢ï¼ˆè‡ªå‹•ï¼‰');
                    
                    // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                    if (mediaRecorder.stream) {
                        mediaRecorder.stream.getTracks().forEach(track => {
                            track.stop();
                            console.log(`ğŸ›‘ éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯åœæ­¢: ${track.label}`);
                        });
                    }
                    
                    console.log('ğŸ”„ éŒ²éŸ³åœæ­¢å®Œäº†ã€æ¬¡ã®éŒ²éŸ³ã‚’å¾…æ©Ÿä¸­...');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰ã«æ›´æ–°
                    updateCurrentText('ğŸ”„ éŸ³å£°èªè­˜ä¸­...', false);
                } catch (error) {
                    console.error('âŒ éŒ²éŸ³åœæ­¢ã‚¨ãƒ©ãƒ¼:', error);
                }
            } else {
                console.log('âš ï¸ éŒ²éŸ³ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
        }
        
        // è‡ªå‹•ä¼šè©±ã®åœæ­¢
        function stopAutoRecording() {
            isAutoRecording = false;
            autoRecording = false;
            
            if (silenceTimer) clearTimeout(silenceTimer);
            if (isRecording) stopRecordingFromStream();
            
            // Fish Audio APIé€£æºãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜ã‚’åœæ­¢
            stopRealtimeSTT();
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            if (microphone) {
                microphone.disconnect();
                microphone = null;
            }
            
            startBtn.textContent = 'ğŸ¤ ä¼šè©±ã™ã‚‹';
            startBtn.disabled = false;
            stopBtn.textContent = 'â¹ï¸ ä¼šè©±åœæ­¢';
            stopBtn.disabled = true;
            recordingIndicator.classList.remove('recording');
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’ç„¡åŠ¹åŒ–
            toggleRealtimeDisplay(false);
            
            console.log('ğŸ›‘ è‡ªå‹•ä¼šè©±åœæ­¢');
        }
        
        // ä¼šè©±é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆè‡ªå‹•ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ï¼‰
        startBtn.addEventListener('click', () => {
            if (!autoRecording) {
                startAutoRecording();
            }
        });
        
        // ä¼šè©±åœæ­¢ãƒœã‚¿ãƒ³ï¼ˆè‡ªå‹•ä¼šè©±åœæ­¢ï¼‰
        stopBtn.addEventListener('click', () => {
            if (autoRecording) {
                stopAutoRecording();
            } else if (isRecording) {
                stopRecordingFromStream();
            }
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: è‡ªå‹•ä¼šè©±ã®çŠ¶æ…‹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
        console.log('ğŸ¤ è‡ªå‹•ä¼šè©±æ©Ÿèƒ½ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
        console.log('ğŸ“‹ ä½¿ç”¨æ–¹æ³•:');
        console.log('1. ğŸ¤ ä¼šè©±ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');

        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã®åˆæœŸåŒ–ç¢ºèª
        console.log('ğŸ–¥ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºè¦ç´ ã®ç¢ºèª:');
        console.log('- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º:', document.getElementById('realtimeAudioDisplay') ? 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('- éŸ³å£°ãƒ¬ãƒ™ãƒ«ãƒãƒ¼:', document.getElementById('audioLevelFill') ? 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('- éŸ³å£°ãƒ¬ãƒ™ãƒ«å€¤:', document.getElementById('audioLevelValue') ? 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('- ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆ:', document.getElementById('currentText') ? 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('- èªè­˜ç²¾åº¦:', document.getElementById('confidenceValue') ? 'âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

        // ä¼šè©±åœæ­¢
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                recordingIndicator.classList.remove('recording');
            }
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addMessage(text, sender, userText = null) {
            const conversationEl = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const currentTime = new Date().toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let messageContent = '';
            if (sender === 'user') {
                messageContent = `
                    <div class="message-avatar">U</div>
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                        <div class="message-time">${currentTime}</div>
                    </div>
                `;
            } else if (sender === 'assistant') {
                messageContent = `
                    <div class="message-avatar">A</div>
                    <div class="message-content">
                        <div class="message-text">${text}</div>
                        ${userText ? `<div class="user-text"><em>ã‚ãªãŸ: "${userText}"</em></div>` : ''}
                        <div class="message-time">${currentTime}</div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = messageContent;
            conversationEl.appendChild(messageDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
            conversationEl.scrollTop = conversationEl.scrollHeight;
            
            console.log(`ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ : ${sender} - ${text}`);
        }

        // ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('sendTextBtn').addEventListener('click', () => {
            const text = textInput.value.trim();
            if (text) {
                const selectedVoice = document.getElementById('voiceSelect').value;
                console.log('ğŸµ é¸æŠã•ã‚ŒãŸéŸ³å£°ãƒ¢ãƒ‡ãƒ«:', selectedVoice);
                console.log('ğŸ“ é€ä¿¡ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ:', text);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                addMessage(text, 'user');
                
                socket.emit('text_message', { 
                    text: text,
                    voice_id: selectedVoice,
                    mode: 'normal'
                });
                textInput.value = '';
            }
        });

        // Enterã‚­ãƒ¼ã§ãƒ†ã‚­ã‚¹ãƒˆé€ä¿¡
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendTextBtn').click();
            }
        });

        // ä¼šè©±ã‚¯ãƒªã‚¢
        clearBtn.addEventListener('click', () => {
            conversationEl.innerHTML = `
                <div class="message assistant">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content">
                        <div class="message-text">ä¼šè©±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</div>
                        <div class="message-time">ä»Š</div>
                    </div>
                </div>
            `;
            console.log('ğŸ—‘ï¸ ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        });

        // éŸ³å£°èªè­˜çµæœã‚’å—ä¿¡
        socket.on('text_recognized', (data) => {
            addMessage(data.text, 'user');
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã«èªè­˜çµæœã‚’è¡¨ç¤º
            updateCurrentText(`ğŸ¯ èªè­˜çµæœ: ${data.text}`, false);
            
            // èªè­˜ç²¾åº¦ã‚’æ›´æ–°ï¼ˆä»®ã®å€¤ï¼‰
            updateConfidence(95);
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTçµæœã‚’å—ä¿¡
        socket.on('realtime_stt_result', (data) => {
            console.log('ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ STTçµæœå—ä¿¡:', data);
            
            if (data.text && data.text.trim()) {
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã«èªè­˜çµæœã‚’è¡¨ç¤º
                updateCurrentText(`ğŸ¯ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜: ${data.text}`, true);
                
                // èªè­˜ç²¾åº¦ã‚’æ›´æ–°
                updateConfidence(data.confidence || 85);
                
                // çŸ­æ™‚é–“å¾Œã«æ¬¡ã®èªè­˜ã‚’å¾…æ©Ÿ
                setTimeout(() => {
                    if (autoRecording && !isRecording) {
                        updateCurrentText('ğŸ¤ æ¬¡ã®éŸ³å£°ã‚’å¾…æ©Ÿä¸­...', false);
                    }
                }, 2000);
            }
        });

        // AIã®å¿œç­”ã‚’å—ä¿¡
        socket.on('audio_response', (data) => {
            console.log('ğŸµ éŸ³å£°å¿œç­”å—ä¿¡:', data);
            
            // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å ´åˆã¯ã€å†…å®¹ã‚’ç›´æ¥è¡¨ç¤º
            if (data.user_text && data.user_text.includes('å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:')) {
                // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†…å®¹ã‚’ç›´æ¥è¡¨ç¤º
                const scriptContent = data.text;
                addMessage(scriptContent, 'assistant', data.user_text);
            } else {
                // é€šå¸¸ã®AIå¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                addMessage(data.text, 'assistant', data.user_text);
            }
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆAIå¿œç­”ä¸­ï¼‰
            updateCurrentText('ğŸ¤– AIãŒå¿œç­”ä¸­...', false);
            
            // éŸ³å£°ã‚’å†ç”Ÿ
            const audioData = atob(data.audio);
            const audioArray = new Uint8Array(audioData.length);
            for (let i = 0; i < audioData.length; i++) {
                audioArray[i] = audioData.charCodeAt(i);
            }
            
            const audioBlob = new Blob([audioArray], { type: 'audio/mp3' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            // éŸ³å£°å†ç”Ÿå®Œäº†å¾Œã®å‡¦ç†
            audio.onended = () => {
                console.log('ğŸµ éŸ³å£°å†ç”Ÿå®Œäº†');
                
                // éŸ³å£°å¿œç­”å®Œäº†å¾Œã€è‡ªå‹•çš„ã«æ¬¡ã®éŒ²éŸ³ã‚’å¾…æ©Ÿ
                if (autoRecording) {
                    console.log('ğŸ”„ éŸ³å£°å¿œç­”å®Œäº†ã€æ¬¡ã®éŒ²éŸ³ã‚’è‡ªå‹•å¾…æ©Ÿä¸­...');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæ¬¡ã®éŒ²éŸ³å¾…æ©Ÿï¼‰
                    updateCurrentText('ğŸ¤ éŸ³å£°ã‚’è©±ã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•éŒ²éŸ³å¾…æ©Ÿä¸­ï¼‰', false);
                    
                    // 3ç§’å¾Œã«æ¬¡ã®éŒ²éŸ³æº–å‚™å®Œäº†
                    setTimeout(() => {
                        if (autoRecording && !isRecording) {
                            console.log('âœ… æ¬¡ã®éŒ²éŸ³ã®æº–å‚™å®Œäº†ã€éŸ³å£°ã‚’å¾…æ©Ÿä¸­...');
                        }
                    }, 3000);
                }
            };
            
            // éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
            audio.onerror = (error) => {
                console.error('âŒ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æ¬¡ã®éŒ²éŸ³ã‚’å¾…æ©Ÿ
                if (autoRecording) {
                    console.log('ğŸ”„ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼å¾Œã€æ¬¡ã®éŒ²éŸ³ã‚’è‡ªå‹•å¾…æ©Ÿä¸­...');
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼å¾Œï¼‰
                    updateCurrentText('ğŸ¤ éŸ³å£°ã‚’è©±ã—ã¦ãã ã•ã„ï¼ˆè‡ªå‹•éŒ²éŸ³å¾…æ©Ÿä¸­ï¼‰', false);
                    
                    setTimeout(() => {
                        if (autoRecording && !isRecording) {
                            console.log('âœ… æ¬¡ã®éŒ²éŸ³ã®æº–å‚™å®Œäº†ã€éŸ³å£°ã‚’å¾…æ©Ÿä¸­...');
                        }
                    }, 2000);
                }
            };
            
            audio.play();
        });
        
        // éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
        socket.on('stt_error', (data) => {
            console.error('âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', data);
            let errorMessage = 'éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
            
            if (data.error && data.error.includes('WAVå½¢å¼')) {
                errorMessage = 'éŸ³å£°å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            } else if (data.error && data.error.includes('Permission denied')) {
                errorMessage = 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
            } else if (data.error) {
                errorMessage = `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${data.error}`;
            }
            
            showError(errorMessage);
            
            // éŒ²éŸ³çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (isAutoRecording) {
                stopAutoRecording();
            }
        });

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            try {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                
                // ä¼šè©±å±¥æ­´ã®æœ€åˆã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŒ¿å…¥
                if (conversationEl && conversationEl.firstChild) {
                    conversationEl.insertBefore(errorDiv, conversationEl.firstChild);
                } else if (conversationEl) {
                    conversationEl.appendChild(errorDiv);
                } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: bodyã®æœ€å¾Œã«è¿½åŠ 
                    document.body.appendChild(errorDiv);
                }
                
                // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
                
                console.log('âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º:', message);
            } catch (e) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', e);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã®ã¿è¡¨ç¤º
                console.error('âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', message);
            }
        }
        

        
        // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('.script-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const step = btn.dataset.step;
                console.log(`ğŸ“‹ å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ: ${step}`);
                executeSalesScript(step);
            });
        });
        
        // å…¨ç·¨å†ç”Ÿãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('fullScriptBtn').addEventListener('click', () => {
            console.log('ğŸ¬ å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ç·¨å†ç”Ÿé–‹å§‹');
            playFullSalesScript();
        });
        
        // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
        function executeSalesScript(step, isFullScript = false) {
            const selectedVoice = document.getElementById('voiceSelect').value;
            
            // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¹ãƒ†ãƒƒãƒ—åã‚’è¡¨ç¤º
            const stepNames = {
                'greeting': 'æŒ¨æ‹¶',
                'introduction': 'è‡ªå·±ç´¹ä»‹',
                'apology': 'è¬ç½ª',
                'business_intro': 'äº‹æ¥­ç´¹ä»‹',
                'product_intro': 'å•†å“ç´¹ä»‹',
                'features': 'ç‰¹å¾´èª¬æ˜',
                'sample_offer': 'ã‚µãƒ³ãƒ—ãƒ«æä¾›',
                'request_info': 'æƒ…å ±ä¾é ¼'
            };
            
            const stepName = stepNames[step] || step;
            
            // å®Œå…¨ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ç”Ÿã®å ´åˆã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
            addMessage(`å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: ${stepName}`, 'user');
            
            // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†…å®¹ã¯éŸ³å£°å¿œç­”å—ä¿¡æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¡¨ç¤ºã—ãªã„
            
            // ã‚µãƒ¼ãƒãƒ¼ã«å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã‚’è¦æ±‚
            socket.emit('text_message', {
                text: `å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ:${step}`,
                voice_id: selectedVoice,
                mode: 'sales'
            });
            
            // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆå®Œå…¨ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ç”Ÿã®å ´åˆã¯ç„¡åŠ¹åŒ–ã—ãªã„ï¼‰
            if (!isFullScript) {
                const btn = document.querySelector(`[data-step="${step}"]`);
                btn.disabled = true;
                btn.textContent = 'â³ å®Ÿè¡Œä¸­...';
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = stepName;
                }, 3000);
            }
        }
        
        // å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ç·¨å†ç”Ÿ
        function playFullSalesScript() {
            const fullScriptBtn = document.getElementById('fullScriptBtn');
            fullScriptBtn.disabled = true;
            fullScriptBtn.textContent = 'â³ å…¨ç·¨å†ç”Ÿä¸­...';
            
            // å…¨ç·¨å†ç”Ÿé–‹å§‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage('å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ç·¨å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã™', 'user');
            
            const salesSteps = ['greeting', 'introduction', 'apology', 'business_intro', 'product_intro', 'features', 'sample_offer'];
            let currentSalesStep = 0;
            
            function playNextStep() {
                if (currentSalesStep < salesSteps.length) {
                    const step = salesSteps[currentSalesStep];
                    console.log(`ğŸ¬ å…¨ç·¨å†ç”Ÿ: ã‚¹ãƒ†ãƒƒãƒ— ${currentSalesStep + 1}/${salesSteps.length} - ${step}`);
                    
                    executeSalesScript(step, true); // å®Œå…¨ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ç”Ÿãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    currentSalesStep++;
                    
                    // éŸ³å£°å†ç”Ÿå®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œ
                    waitForAudioCompletion(playNextStep);
                } else {
                    // å…¨ç·¨å†ç”Ÿå®Œäº†
                    fullScriptBtn.disabled = false;
                    fullScriptBtn.textContent = 'å®Œå…¨ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ç”Ÿ';
                    console.log('âœ… å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ç·¨å†ç”Ÿå®Œäº†');
                    
                    // å…¨ç·¨å†ç”Ÿå®Œäº†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    addMessage('å–¶æ¥­ã‚¹ã‚¯ãƒªãƒ—ãƒˆå…¨ç·¨å†ç”ŸãŒå®Œäº†ã—ã¾ã—ãŸ', 'assistant');
                }
            }
            
            // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹
            playNextStep();
        }
        
        // éŸ³å£°å†ç”Ÿå®Œäº†ã‚’å¾…ã¤é–¢æ•°
        function waitForAudioCompletion(callback) {
            // éŸ³å£°å¿œç­”ã‚’å—ä¿¡ã—ãŸã‚‰æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
            const originalHandler = socket.onevent;
            let audioCompleted = false;
            
            socket.onevent = function(packet) {
                if (packet.data && packet.data[0] === 'audio_response' && !audioCompleted) {
                    audioCompleted = true;
                    console.log('ğŸµ éŸ³å£°å¿œç­”å—ä¿¡ã€éŸ³å£°å†ç”Ÿå®Œäº†ã‚’å¾…æ©Ÿä¸­...');
                    
                    // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å†ç”Ÿ
                    const audioData = atob(packet.data[1].audio);
                    const audioArray = new Uint8Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        audioArray[i] = audioData.charCodeAt(i);
                    }
                    
                    const audioBlob = new Blob([audioArray], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    // éŸ³å£°å†ç”Ÿå®Œäº†æ™‚ã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
                    audio.addEventListener('ended', () => {
                        console.log('ğŸµ éŸ³å£°å†ç”Ÿå®Œäº†ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™');
                        // å…ƒã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å¾©å…ƒ
                        socket.onevent = originalHandler;
                        // å¾…æ©Ÿæ™‚é–“ã‚’çŸ­ç¸®ï¼ˆ0.5ç§’ï¼‰
                        setTimeout(callback, 500);
                    });
                    
                    // éŸ³å£°å†ç”Ÿé–‹å§‹
                    audio.play().catch(e => {
                        console.log('âš ï¸ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™:', e);
                                            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
                    setTimeout(() => {
                        socket.onevent = originalHandler;
                        callback();
                    }, 1500);
                    });
                    
                    return;
                }
                // å…ƒã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã—
                originalHandler.call(this, packet);
            };
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆ8ç§’å¾Œã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ï¼‰
            setTimeout(() => {
                if (!audioCompleted) {
                    console.log('â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™');
                    socket.onevent = originalHandler;
                    callback();
                }
            }, 8000);
        }
        
        // ä¼šè©±ç®¡ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateConversationStatus() {
            // ä¼šè©±ç®¡ç†ã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
            const conversationStateEl = document.getElementById('conversationState');
            const slotCompletionRateEl = document.getElementById('slotCompletionRate');
            const nextQuestionEl = document.getElementById('nextQuestion');
            
            if (conversationStateEl && slotCompletionRateEl && nextQuestionEl) {
                // ç¾åœ¨ã®ä¼šè©±å±¥æ­´ã‹ã‚‰çŠ¶æ…‹ã‚’æ¨æ¸¬
                const messages = document.querySelectorAll('.message');
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    const isUserMessage = lastMessage.classList.contains('user');
                    
                    if (isUserMessage) {
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ã€æ¬¡ã®è³ªå•ã‚’æº–å‚™
                        conversationStateEl.textContent = 'å¿œç­”å¾…ã¡';
                        slotCompletionRateEl.textContent = 'è¨ˆç®—ä¸­...';
                        nextQuestionEl.textContent = 'AIãŒå¿œç­”ã‚’ç”Ÿæˆä¸­...';
                    } else {
                        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æº–å‚™
                        conversationStateEl.textContent = 'å¿œç­”å®Œäº†';
                        slotCompletionRateEl.textContent = 'æ¬¡ã®å…¥åŠ›å¾…ã¡';
                        nextQuestionEl.textContent = 'éŸ³å£°ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                    }
                } else {
                    // ä¼šè©±å±¥æ­´ãŒãªã„å ´åˆ
                    conversationStateEl.textContent = 'åˆæœŸçŠ¶æ…‹';
                    slotCompletionRateEl.textContent = '0%';
                    nextQuestionEl.textContent = 'ä¼šè©±ã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
                }
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«çŠ¶æ…‹è¡¨ç¤ºã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateConversationStatus();
        });
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ æ™‚ã«çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
        const originalAddMessage = window.addMessage;
        window.addMessage = function(text, sender, userText) {
            originalAddMessage.call(this, text, sender, userText);
            updateConversationStatus();
        };

    </script>
</body>
</html>
