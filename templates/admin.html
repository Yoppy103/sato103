<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>管理コンソール - オートダイヤラー</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; background: #f7f7fb; }
        header { background: #333; color: #fff; padding: 12px 16px; }
        main { padding: 16px; max-width: 960px; margin: 0 auto; }
        h1 { font-size: 20px; margin: 0; }
        section { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        input[type="file"] { padding: 6px; }
        button { background: #2563eb; color: #fff; border: 0; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
        button.secondary { background: #6b7280; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background: #f3f4f6; }
        .muted { color: #6b7280; font-size: 12px; }
        .status { padding: 4px 8px; border-radius: 4px; background: #eef2ff; color: #1d4ed8; display: inline-block; }
    </style>
</head>
<body>
    <header>
        <h1>管理コンソール - オートダイヤラー</h1>
    </header>
    <main>
        <section>
            <h3>CSV取り込み</h3>
            <p class="muted">phone,name のヘッダを含むCSVをアップロードしてください</p>
            <div class="row">
                <input id="csvFile" type="file" accept=".csv" />
                <button id="uploadBtn">アップロード</button>
                <span id="uploadResult" class="muted"></span>
            </div>
        </section>
        <section>
            <h3>ダイヤラー操作</h3>
            <div class="row">
                <button id="startBtn">開始</button>
                <button id="stopBtn" class="secondary">停止</button>
                <button id="clearBtn" class="secondary">キュー/履歴クリア</button>
                <span>状態: <span id="status" class="status">-</span></span>
                <span>キュー数: <strong id="queueLen">0</strong></span>
            </div>
        </section>
        <section>
            <h3>発信基盤テスト（Twilio）</h3>
            <div class="row">
                <input id="toNumber" type="tel" placeholder="発信先 (E.164) 例: +818012345678" style="flex:1; padding:6px;" />
                <button id="twilioCallBtn">発信テスト</button>
                <span id="twilioResult" class="muted"></span>
            </div>
            <p class="muted">環境変数に TWILIO_ACCOUNT_SID / TWILIO_AUTH_TOKEN / TWILIO_FROM_NUMBER / PUBLIC_BASE_URL を設定してください。</p>
        </section>
        <section>
            <h3>結果履歴（最新20件）</h3>
            <table>
                <thead>
                    <tr>
                        <th>電話番号</th>
                        <th>名前</th>
                        <th>結果</th>
                        <th>開始</th>
                        <th>終了</th>
                    </tr>
                </thead>
                <tbody id="resultBody"></tbody>
            </table>
        </section>
    </main>
    <script>
        async function post(url, formData) {
            const res = await fetch(url, { method: 'POST', body: formData });
            return res.json();
        }
        async function postJson(url, payload) {
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload || {}) });
            return res.json();
        }
        async function getJson(url) {
            const res = await fetch(url);
            return res.json();
        }

        const csvFile = document.getElementById('csvFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadResult = document.getElementById('uploadResult');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusEl = document.getElementById('status');
        const queueLenEl = document.getElementById('queueLen');
        const resultBody = document.getElementById('resultBody');
        const toNumber = document.getElementById('toNumber');
        const twilioCallBtn = document.getElementById('twilioCallBtn');
        const twilioResult = document.getElementById('twilioResult');

        uploadBtn.onclick = async () => {
            if (!csvFile.files[0]) { uploadResult.textContent = 'ファイルを選択してください'; return; }
            const fd = new FormData();
            fd.append('file', csvFile.files[0]);
            const res = await post('/admin/api/upload', fd);
            uploadResult.textContent = res.ok ? `取り込み: ${res.added} 件, キュー: ${res.queue}` : `失敗: ${res.error}`;
            await refreshStatus();
        };
        startBtn.onclick = async () => { await postJson('/admin/api/start'); await refreshStatus(); };
        stopBtn.onclick = async () => { await postJson('/admin/api/stop'); await refreshStatus(); };
        clearBtn.onclick = async () => { await postJson('/admin/api/clear'); await refreshStatus(); };

        twilioCallBtn.onclick = async () => {
            twilioResult.textContent = '';
            try {
                const res = await postJson('/admin/api/twilio/test', { to: toNumber.value.trim() });
                twilioResult.textContent = res.ok ? `Call SID: ${res.sid}` : `失敗: ${res.error}`;
            } catch (e) {
                twilioResult.textContent = `失敗: ${e.message}`;
            }
        };

        async function refreshStatus() {
            const res = await getJson('/admin/api/status');
            if (!res.ok) return;
            const d = res.data;
            statusEl.textContent = d.status;
            queueLenEl.textContent = d.queue_length;
            resultBody.innerHTML = '';
            (d.results || []).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.phone || '-'}</td>
                    <td>${r.name || '-'}</td>
                    <td>${r.result}</td>
                    <td>${r.started_at ? new Date(r.started_at*1000).toLocaleString() : '-'}</td>
                    <td>${r.ended_at ? new Date(r.ended_at*1000).toLocaleString() : '-'}</td>
                `;
                resultBody.appendChild(tr);
            });
        }

        setInterval(refreshStatus, 1500);
        refreshStatus();
    </script>
</body>
</html>


